pipeline {
  parameters {
    choice(name: 'terraformAction', choices: ['apply', 'destroy'], description: 'Choose your terraform action to perform')
  }

  environment {
    AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
  }

  agent any

  stages {
    stage('Checkout') {
      steps {
        // Clone the repo into workspace root (no extra dir)
        git branch: 'jenkins-server', url: 'https://github.com/Prajwal8651/git-for-devops.git'
      }
    }

    stage('Detect Terraform Directory') {
      steps {
        script {
          // Detect common terraform directory names. Falls back to workspace root (.)
          def detector = '''
if [ -d terraform ]; then
  echo terraform
elif [ -d Project-1 ]; then
  echo Project-1
elif [ -d iac-repo/Project-1 ]; then
  echo iac-repo/Project-1
else
  echo .
fi
'''
          env.TF_DIR = sh(script: detector, returnStdout: true).trim()
          echo "Using Terraform directory: ${env.TF_DIR}"
        }
      }
    }

    stage('Plan') {
      steps {
        script {
          // Run terraform init/plan inside detected directory and write human-readable plan to workspace root
          dir(env.TF_DIR) {
            sh 'terraform init -input=false'
            sh 'terraform plan -out=tfplan -input=false'
            // Write plan to workspace root for approval review
            sh "terraform show -no-color tfplan > ${env.WORKSPACE}/tfplan.txt"
          }
        }
      }
    }

    stage('Approval') {
      steps {
        script {
          // Read the plan file created in workspace root and prompt for approval (shows the plan in the input text box)
          def planContent = readFile "${env.WORKSPACE}/tfplan.txt"
          input message: "Do you want to proceed with terraform action?",
                parameters: [text(name: 'planReview', description: 'Review the generated plan and confirm', defaultValue: planContent)]
        }
      }
    }

    stage('Apply or Destroy') {
      when {
        expression { return params.terraformAction == 'apply' || params.terraformAction == 'destroy' }
      }

      steps {
        script {
          if (params.terraformAction == 'apply') {
            dir(env.TF_DIR) {
              // Apply using the previously-created plan file (tfplan)
              sh 'terraform apply -input=false tfplan'
            }
          } else {
            dir(env.TF_DIR) {
              // Destroy the infrastructure
              sh 'terraform destroy -auto-approve'
            }
          }
        }
      }
    }
  } // stages
}
